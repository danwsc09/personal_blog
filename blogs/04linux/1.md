---
title: pm2 를 이용한 deployment
sidebar_position: 1
---
Last updated: 2021/12/16 Thurs

## PM2 config
`ecosystem.config.js` 에 pm2 의 실행 변수 및 환경을 지정할 수 있다.  
[여기서](https://pm2.keymetrics.io/docs/usage/application-declaration/) 바로 읽을 수 있는 내용이다.

기본적으로 `name`, `script`, `args`, `interpreter`, `interpreter_args` 등을 설정할 수 있다. 기본적으로는 `node` 로 되지만 `interpreter` 를 `/usr/bin/python` 로 바꿔서 파이썬을 실행 할 수 있다.  

`instances`, `exec_mode`, `watch`, `env`, `env-` 등 도 있다.

## My PC --> GCE
[이걸](https://hashinteractive.com/blog/ci-cd-using-pm2-deploy-for-node-application/) 보고 참조했다.  
인스턴스를 생성한 후, 가장 첫번째로 해야할 건 key-pair 를 만드는 것이다. 여기서 pair 중에 private 은 내 컴퓨터에 계속 남고, 내가 들어가고자 하는 컴퓨터/서버에 public key 를 넣으면 된다.  
`ssh-keygen` 으로 이름이 `deploy_rsa` 라는 key pair 를 만든다. `deploy_rsa.pub` 을 복사해서 서버의 `~/.ssh/authorized_keys` 에 붙여 넣는다. 그러면 `ssh -i ~/.ssh/deploy_rsa <username>@<ip>` 로 접속할 수 있다.  
여기서 Google Cloud Compute Engine 은 웹에서 접속할 시 `~/.ssh/authorized_keys` 에 키를 붙이고, 이 웹 콘솔에서 나오면 저 파일이 1-2분 후에 사라진다. 따라서, public key 는 `~/.ssh/authorized_keys2` 에 저장한 후, `/etc/ssh/sshd_config` -> `AuthorizedKeyFile` 에 # 를 풀었다 (`authorized_keys`, `authorized_keys2`).  
여기까지 했으면 `ssh -i ~/.ssh/deploy_rsa <user>@<ip>` 로 접속이 가능하다.  

## GCE --> Github
서버에서 `ssh-keygen -t rsa` 로 key pair 만든다. 여기서 이름은 그냥 id_rsa 로 냅둔다.  
github > settings > SSH and GPG keys > New SSH Key > 클라우드 에서 방금 만든 id_rsa.pub 의 내용을 붙여넣고, 클라우드라고 명시하고 저장한다.  
여기까지 하면 git pull/clone 이 가능하다. `git` 이 없어서 `sudo apt-get install git` 해서 다운 받았다.  
이 후, nvm, node, yarn, pm2 를 다운 받았다. `nvm use 16`, `npm i -g yarn`, `yarn add global pm2` 까지 한다.  
`export PATH="$PATH:$(yarn global bin)"` 를 ~/.bash_profile 에 추가한다.  

## My PC --> GCE (deployment)
다시 내 PC (deploy 를 실행할 컴퓨터) 에서 `<path>/app` 에서 github 에 연동 한 후 `git push --set-upstream origin master` 를 먼저 한다.  
후에, `pm2 deploy production setup` 을 하고, `pm2 deploy production` 을 실행하면 된다.  
명심할 것들:
- `git push` 를 하고 나서야지만 deploy 가 된다. - Github repo 의 코드와 내가 지금 있는 folder 가 같은 커밋을 가리키고 있어야 한다.
- `yarn` 혹은 `npm` 을 모른다고 할 수 있다.~~[여기를](https://forum.gitlab.com/t/gitlab-ci-cd-npm-not-found/59318/8) 참조해서 pre-deploy 에 PATH 추가.~~
- `pm2` not found 까지 뜰 수 있다. PATH 에 다시 넣어서 해본다.
  - ~~yarn, pm2 를 썼을땐 `tee: command not found` 가 떴다.~~
  - ~~npm, pm2 를 사용해본다.~~
  - ~~똑같이 tee command not found.~~
  - ~~`source ~/.bash_profile` 추가~~
  - 해결: GCE 에서는 sudo 하면 비번을 치라고해서 (생성한적이 없는), web console 을 이용해 node, yarn, 그리고 pm2 를 `/usr/bin` 에 넣는다:
```
whereis node
whereis pm2
whereis yarn
sudo ln -s /home/<user>/<path>/<to>/<node>/bin /usr/bin/node
sudo ln -s /home/<user>/<path>/<to>/<pm2>/bin /usr/bin/pm2
sudo ln -s /home/<user>/<path>/<to>/<yarn>/bin /usr/bin/yarn
```
### Notes
확인 필요!: pm2 에서 pre-deploy 와 post-deploy 가 다른 context? connection? 에서 실행되는거 같다. PATH 가 pre-deploy 에서 지정했는데도 post-deploy 에는 없던거 같았다.

## GCE Network Tags
firewall rule 에 3000 과 0.0.0.0/0 을 추가하고, 이름을 Port3k 라고 지었다.
인스턴스 이름을 누르고 edit - network tag (Port3k) 를 추가한다.  
이 부분은 해본건데 `123.123.123.123:3000` 을 주소창에 쳐봤는데 안나왔다. GCE Console 에 보면 3000 에 접근한건 보이는데 주소창에는 안뜬다. 왜인지는 모르겠다.

